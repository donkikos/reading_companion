## Codebase Patterns
- Skip EPUB navigation docs like `nav.xhtml` when building sentence streams from the spine.
- On re-ingest, clear existing Chroma docs, chapters, and Qdrant chunks by `book_id` before reindexing.
- Ingestion progress percentages are derived from total sentence counts computed before streaming.
- Use `IngestionProgress` stage ranges to map full-pipeline progress updates to UI percentages.
- Check Qdrant availability with `_ensure_qdrant_available` before collection operations to fail fast.
- In ingestion tests, use fake Qdrant and Chroma clients to avoid external service dependencies.
- Set `QDRANT_PATH` to use a local Qdrant store without a running server.
- TEI embeddings use `/embed` with `TEI_BASE_URL`, and tests should stub `_tei_embed` for determinism.
- TEI Docker image is amd64-only; `docker-compose.yml` pins `platform: linux/amd64` for the tei service.
- When evolving the SQLite schema, use `PRAGMA table_info` plus `ALTER TABLE` to add new columns.
- Startup cleanup compares Qdrant payload `book_id`s to SQLite `books` and deletes orphaned chunks via scroll.

## 2026-01-13 18:56 - US-001
- What was implemented: Added deterministic sentence stream builder with contiguous IDs and nav skipping; ingestion now uses it and added tests.
- Files changed: ingest.py, main.py, tests/test_sentence_stream.py, prd.json
- Testing: ruff format ingest.py main.py tests/test_sentence_stream.py; ruff check .; pytest
- **Learnings for future iterations:** The EPUB spine includes nav documents that should be excluded from indexing to keep sentences clean.
---
## 2026-01-13 18:57 - US-002
- What was implemented: Added fixed-window chunk builder with 8-sentence window and 2-sentence overlap, plus coverage tests.
- Files changed: ingest.py, tests/test_chunks.py, prd.json
- Testing: ruff format ingest.py tests/test_chunks.py; ruff check .; pytest
- **Learnings for future iterations:** Fixed-window chunking uses sentence indices to preserve deterministic [pos_start..pos_end] ranges.
---
## 2026-01-13 19:01 - US-003
- What was implemented: Added Qdrant chunk payload construction and upsert during ingestion, plus deterministic hash embeddings and payload tests.
- Files changed: ingest.py, tests/test_qdrant_payloads.py, requirements.txt, prd.json
- Testing: ruff format ingest.py tests/test_qdrant_payloads.py; ruff check .; pytest
- **Learnings for future iterations:** Chunk payloads derive pos_start/pos_end from stream seq_ids and use a deterministic hash embedding when creating Qdrant vectors.
---
## 2026-01-13 19:15 - US-004
- What was implemented: Added re-ingest path that clears prior Chroma, chapters, and Qdrant chunks before reindexing; updated book metadata and preserved cursor on reupload; added Qdrant filter tests.
- Files changed: ingest.py, db.py, tests/test_qdrant_payloads.py, progress.txt, prd.json
- Testing: ruff format ingest.py db.py tests/test_qdrant_payloads.py; ruff check .; pytest
- **Learnings for future iterations:** Re-ingestion should clear all existing per-book storage before new chunk upserts to avoid stale Qdrant points and duplicate chapter data.
---
## 2026-01-13 19:18 - US-005
- What was implemented: Updated sentence stream building to precompute total sentence counts and report progress per processed sentence; added progress callback test coverage.
- Files changed: ingest.py, tests/test_sentence_stream.py, progress.txt, prd.json
- Testing: ruff format ingest.py tests/test_sentence_stream.py; ruff check .; pytest
- **Learnings for future iterations:** Sentence-based ingestion progress needs a precomputed total to provide accurate percentages during stream building.
---
## 2026-01-13 19:20 - US-006
- What was implemented: Added a Qdrant availability check that raises a clear error before chunk upserts and added coverage for reachable/unreachable clients.
- Files changed: ingest.py, tests/test_qdrant_payloads.py, progress.txt, prd.json
- Testing: ruff format ingest.py tests/test_qdrant_payloads.py; ruff check .; pytest
- **Learnings for future iterations:** Guard Qdrant operations with an explicit availability check to avoid silent partial ingestion.
---
## 2026-01-15 07:07 - US-007
- What was implemented: Added an ingestion verification API that recomputes expected chunks, checks Qdrant counts, and validates sample payloads; added endpoint tests.
- Files changed: main.py, tests/test_verify_ingestion.py, prd.json
- Testing: ruff format main.py tests/test_verify_ingestion.py; ruff check .; pytest
- **Learnings for future iterations:** Verification uses Qdrant count + sample scroll to validate payload integrity and monotonic positions.
---
## 2026-01-15 08:16 - US-008
- What was implemented: Added Dockerfile and docker-compose stack with app, Qdrant, and a healthcheck runner that verifies both services; documented the single compose command; added a basic compose presence test.
- Files changed: Dockerfile, docker-compose.yml, scripts/compose_healthcheck.py, tests/test_docker_compose.py, prd.json
- Testing: ruff format scripts/compose_healthcheck.py tests/test_docker_compose.py; ruff check .; pytest
- **Learnings for future iterations:** Compose health checks can be enforced by a short-lived healthcheck service that polls app + Qdrant and exits with status.
---
## 2026-01-15 08:43 - US-009
- What was implemented: Added a deterministic ASCII-only EPUB fixture and an ingestion test that indexes it and verifies chunk counts via the verification API using fake Qdrant/Chroma.
- Files changed: tests/fixtures/minimal.epub, tests/test_ingestion_fixture.py, progress.txt, prd.json
- Testing: ruff format tests/test_ingestion_fixture.py; ruff check .; pytest
- **Learnings for future iterations:** Ingestion verification tests can rely on in-memory Qdrant/Chroma fakes to keep them deterministic and independent of external services.
---
## 2026-01-15 09:02 - US-010
- What was implemented: Added delete endpoint that removes book files, SQLite records, Chroma docs, and Qdrant chunks; added library delete UI with confirmation and client-side removal; added tests and local Qdrant path support.
- Files changed: main.py, db.py, ingest.py, static/script.js, static/style.css, tests/test_delete_book.py, prd.json, progress.txt
- Testing: ruff format main.py db.py ingest.py tests/test_delete_book.py; ruff check .; pytest
- **Learnings for future iterations:** QDRANT_PATH enables local Qdrant usage for dev workflows without a running server.
---
## 2026-01-18 08:48 - US-012
- What was implemented: Added Ollama embedding client and wired ingestion to call `/api/embed` with configurable model/base URL/dim; updated Qdrant point building; added Ollama compose service and tests covering embedding responses/errors.
- Files changed: ingest.py, docker-compose.yml, tests/test_ingestion_fixture.py, tests/test_qdrant_integration.py, tests/test_ollama_embed.py, prd.json, progress.txt
- Testing: ruff format ingest.py tests/test_ingestion_fixture.py tests/test_qdrant_integration.py tests/test_ollama_embed.py; ruff check .; pytest
- **Learnings for future iterations:** Ollama embedding calls require alignment between returned vector length and Qdrant collection size.
---
## 2026-01-18 12:04 - US-014
- What was implemented: Added an end-to-end Ollama + Qdrant ingestion integration test and ensured Ollama embedding defaults are resolved at call time.
- Files changed: ingest.py, tests/test_ollama_integration.py, progress.txt
- Testing: ruff format ingest.py tests/test_ollama_integration.py; ruff check .; pytest
- **Learnings for future iterations:** Ollama model selection should be resolved at call time so tests can swap models without default-arg capture.
---
## 2026-01-18 13:39 - US-011
- What was implemented: Added full-pipeline ingestion progress staging (hashing/parsing/chunking/embedding/Qdrant/metadata), updated task messages, and added ingestion progress tests.
- Files changed: ingest.py, main.py, tests/test_ingestion_progress.py, progress.txt
- Testing: ruff format ingest.py main.py tests/test_ingestion_progress.py; ruff check .; pytest; Playwright browser verification blocked (browser install unsupported on Linux Arm64).
- **Learnings for future iterations:** Playwright browser install fails on Linux Arm64 in this environment; plan alternate UI verification or provide a supported browser bundle.
---
## 2026-01-18 19:08 - US-013
- What was implemented: Stored embedding model/dimension in the books table during ingestion and documented reindexing guidance; added schema migration guards and tests.
- Files changed: db.py, ingest.py, tests/test_ingestion_fixture.py, progress.txt, prd.json
- Testing: ruff format db.py ingest.py tests/test_ingestion_fixture.py; ruff check .; pytest
- **Learnings for future iterations:** Existing SQLite state files may lack new columns, so migrations should be enforced in write paths as well as init.
---
## 2026-01-18 19:13 - US-011
- What was implemented: Verified existing ingestion progress UI and backend wiring; no code changes required.
- Files changed: progress.txt
- Testing: ruff check .; pytest
- **Learnings for future iterations:** Browser verification is still blocked because the Playwright MCP server is unavailable in this environment.
---
## 2026-01-23 05:46 - US-017
- What was implemented: Swapped ingestion embeddings to TEI `/embed` with batching, updated compose/services/env vars, refreshed docs/README, and migrated tests to TEI.
- Files changed: ingest.py, docker-compose.yml, docker-compose.dev.yml, tests/test_tei_embed.py, tests/test_tei_integration.py, tests/test_ingestion_fixture.py, tests/test_ingestion_progress.py, tests/test_qdrant_integration.py, docs/notes.md, AGENTS.md, README.md, progress.txt
- Testing: ruff format ingest.py tests/test_tei_embed.py tests/test_tei_integration.py tests/test_ingestion_fixture.py tests/test_ingestion_progress.py tests/test_qdrant_integration.py; ruff check .; pytest (TEI integration test skipped: TEI unavailable)
- **Learnings for future iterations:** TEI `/embed` can return a single vector for one input; normalize to list-of-lists and batch requests to keep payloads reasonable.
---
## 2026-01-23 06:16 - US-017
- What was implemented: Switched TEI default model to `BAAI/bge-base-en-v1.5`, pinned the TEI service to amd64 in Compose for Apple silicon, and verified live TEI embeddings via integration tests.
- Files changed: ingest.py, docker-compose.yml, docker-compose.dev.yml, README.md, progress.txt
- Testing: ruff format ingest.py; ruff check .; pytest (TEI integration test ran against live TEI)
- **Learnings for future iterations:** The TEI CPU image is amd64-only and must be pinned in Compose on Apple silicon to run the integration test.
---
## 2026-01-23 06:36 - US-019
- What was implemented: Added startup cleanup that scans Qdrant payload book_id values against SQLite and deletes orphaned chunks; wired into FastAPI lifespan with logging; added unit tests; ensured pytest single-test runs from repo root.
- Files changed: ingest.py, main.py, tests/test_qdrant_cleanup.py, tests/conftest.py, progress.txt
- Testing: ruff format; ruff check .; pytest
- **Learnings for future iterations:** Prefer FastAPI lifespan handlers over deprecated on_event hooks; add tests/conftest.py to keep repo root on sys.path for single-test runs.
---
