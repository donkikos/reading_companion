## Codebase Patterns
- Skip EPUB navigation docs like `nav.xhtml` when building sentence streams from the spine.
- On re-ingest, clear existing Chroma docs, chapters, and Qdrant chunks by `book_id` before reindexing.
- Ingestion progress percentages are derived from total sentence counts computed before streaming.
- Check Qdrant availability with `_ensure_qdrant_available` before collection operations to fail fast.

## 2026-01-13 18:56 - US-001
- What was implemented: Added deterministic sentence stream builder with contiguous IDs and nav skipping; ingestion now uses it and added tests.
- Files changed: ingest.py, main.py, tests/test_sentence_stream.py, prd.json
- Testing: ruff format ingest.py main.py tests/test_sentence_stream.py; ruff check .; pytest
- **Learnings for future iterations:** The EPUB spine includes nav documents that should be excluded from indexing to keep sentences clean.
---
## 2026-01-13 18:57 - US-002
- What was implemented: Added fixed-window chunk builder with 8-sentence window and 2-sentence overlap, plus coverage tests.
- Files changed: ingest.py, tests/test_chunks.py, prd.json
- Testing: ruff format ingest.py tests/test_chunks.py; ruff check .; pytest
- **Learnings for future iterations:** Fixed-window chunking uses sentence indices to preserve deterministic [pos_start..pos_end] ranges.
---
## 2026-01-13 19:01 - US-003
- What was implemented: Added Qdrant chunk payload construction and upsert during ingestion, plus deterministic hash embeddings and payload tests.
- Files changed: ingest.py, tests/test_qdrant_payloads.py, requirements.txt, prd.json
- Testing: ruff format ingest.py tests/test_qdrant_payloads.py; ruff check .; pytest
- **Learnings for future iterations:** Chunk payloads derive pos_start/pos_end from stream seq_ids and use a deterministic hash embedding when creating Qdrant vectors.
---
## 2026-01-13 19:15 - US-004
- What was implemented: Added re-ingest path that clears prior Chroma, chapters, and Qdrant chunks before reindexing; updated book metadata and preserved cursor on reupload; added Qdrant filter tests.
- Files changed: ingest.py, db.py, tests/test_qdrant_payloads.py, progress.txt, prd.json
- Testing: ruff format ingest.py db.py tests/test_qdrant_payloads.py; ruff check .; pytest
- **Learnings for future iterations:** Re-ingestion should clear all existing per-book storage before new chunk upserts to avoid stale Qdrant points and duplicate chapter data.
---
## 2026-01-13 19:18 - US-005
- What was implemented: Updated sentence stream building to precompute total sentence counts and report progress per processed sentence; added progress callback test coverage.
- Files changed: ingest.py, tests/test_sentence_stream.py, progress.txt, prd.json
- Testing: ruff format ingest.py tests/test_sentence_stream.py; ruff check .; pytest
- **Learnings for future iterations:** Sentence-based ingestion progress needs a precomputed total to provide accurate percentages during stream building.
---
## 2026-01-13 19:20 - US-006
- What was implemented: Added a Qdrant availability check that raises a clear error before chunk upserts and added coverage for reachable/unreachable clients.
- Files changed: ingest.py, tests/test_qdrant_payloads.py, progress.txt, prd.json
- Testing: ruff format ingest.py tests/test_qdrant_payloads.py; ruff check .; pytest
- **Learnings for future iterations:** Guard Qdrant operations with an explicit availability check to avoid silent partial ingestion.
---
## 2026-01-15 07:07 - US-007
- What was implemented: Added an ingestion verification API that recomputes expected chunks, checks Qdrant counts, and validates sample payloads; added endpoint tests.
- Files changed: main.py, tests/test_verify_ingestion.py, prd.json
- Testing: ruff format main.py tests/test_verify_ingestion.py; ruff check .; pytest
- **Learnings for future iterations:** Verification uses Qdrant count + sample scroll to validate payload integrity and monotonic positions.
---
## 2026-01-15 08:16 - US-008
- What was implemented: Added Dockerfile and docker-compose stack with app, Qdrant, and a healthcheck runner that verifies both services; documented the single compose command; added a basic compose presence test.
- Files changed: Dockerfile, docker-compose.yml, scripts/compose_healthcheck.py, tests/test_docker_compose.py, prd.json
- Testing: ruff format scripts/compose_healthcheck.py tests/test_docker_compose.py; ruff check .; pytest
- **Learnings for future iterations:** Compose health checks can be enforced by a short-lived healthcheck service that polls app + Qdrant and exits with status.
---
